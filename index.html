// ===========================================================
// All-in-One Tools Frontend Logic
// Created by Marri Bala Bhaskar üí´
// ===========================================================

// -------------------- Helper --------------------
const qs = (sel) => document.querySelector(sel);
const qsa = (sel) => document.querySelectorAll(sel);

// ===========================================================
// üß© PDF MERGER
// ===========================================================
qs("#mergeBtn").addEventListener("click", async () => {
  const files = qs("#pdfFiles").files;
  if (files.length < 2) {
    alert("Please select at least 2 PDF files.");
    return;
  }

  const formData = new FormData();
  for (let f of files) formData.append("pdfs", f);

  try {
    qs("#mergeResult").textContent = "Merging PDFs...";
    const res = await fetch("https://all-in-one-tools-backend.onrender.com/merge", {
      method: "POST",
      body: formData,
    });
    const blob = await res.blob();
    const url = URL.createObjectURL(blob);
    const link = document.createElement("a");
    link.href = url;
    link.download = "merged.pdf";
    link.click();
    qs("#mergeResult").textContent = "‚úÖ Merged PDF downloaded successfully!";
  } catch (err) {
    console.error(err);
    qs("#mergeResult").textContent = "‚ùå Error merging PDFs.";
  }
});

// ===========================================================
// üîê FILE ENCRYPTION / DECRYPTION
// ===========================================================
qs("#encryptBtn").addEventListener("click", async () => {
  const file = qs("#encFile").files[0];
  const password = qs("#encPassword").value;
  if (!file || !password) {
    alert("Please select a file and enter a password.");
    return;
  }

  const formData = new FormData();
  formData.append("file", file);
  formData.append("password", password);

  qs("#encResult").textContent = "Encrypting...";
  const res = await fetch("https://all-in-one-tools-backend.onrender.com/encrypt", {
    method: "POST",
    body: formData,
  });
  const blob = await res.blob();
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = `encrypted_${file.name}.enc`;
  a.click();
  qs("#encResult").textContent = "‚úÖ File encrypted successfully!";
});

qs("#decryptBtn").addEventListener("click", async () => {
  const file = qs("#decFile").files[0];
  const password = qs("#decPassword").value;
  if (!file || !password) {
    alert("Please select a file and enter the password used for encryption.");
    return;
  }

  const formData = new FormData();
  formData.append("file", file);
  formData.append("password", password);

  qs("#decResult").textContent = "Decrypting...";
  const res = await fetch("https://all-in-one-tools-backend.onrender.com/decrypt", {
    method: "POST",
    body: formData,
  });
  const blob = await res.blob();
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = `decrypted_${file.name.replace(".enc", "")}`;
  a.click();
  qs("#decResult").textContent = "‚úÖ File decrypted successfully!";
});

// ===========================================================
// üñºÔ∏è IMAGE CONVERTER
// ===========================================================
qs("#convertImgBtn").addEventListener("click", async () => {
  const file = qs("#imgFile").files[0];
  const format = qs("#imgFormat").value;

  if (!file || !format) {
    alert("Please select an image and format.");
    return;
  }

  const formData = new FormData();
  formData.append("image", file);
  formData.append("format", format);

  qs("#imgResult").textContent = "Converting...";
  try {
    const res = await fetch("https://all-in-one-tools-backend.onrender.com/convert-image", {
      method: "POST",
      body: formData,
    });
    const blob = await res.blob();
    const url = URL.createObjectURL(blob);
    const link = document.createElement("a");
    link.href = url;
    link.download = `converted.${format}`;
    link.click();
    qs("#imgResult").textContent = "‚úÖ Image converted successfully!";
  } catch (err) {
    console.error(err);
    qs("#imgResult").textContent = "‚ùå Conversion failed.";
  }
});

// ===========================================================
// üß† AI CHAT TOOL
// ===========================================================
qs("#aiSendBtn").addEventListener("click", async () => {
  const input = qs("#aiInput").value.trim();
  const output = qs("#aiOutput");
  if (!input) return alert("Enter a prompt!");

  output.textContent = "ü§ñ Thinking...";
  try {
    const res = await fetch("https://all-in-one-tools-backend.onrender.com/ai", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ prompt: input }),
    });
    const data = await res.json();
    output.textContent = "üí¨ " + data.reply;
  } catch (err) {
    console.error(err);
    output.textContent = "‚ùå AI service unavailable.";
  }
});

// ===========================================================
// üîä TEXT TO SPEECH
// ===========================================================
qs("#ttsBtn").addEventListener("click", () => {
  const text = qs("#ttsInput").value;
  if (!text) return alert("Enter text to speak!");
  const speech = new SpeechSynthesisUtterance(text);
  speech.lang = "en-US";
  speechSynthesis.speak(speech);
});

// ===========================================================
// üîê PASSWORD GENERATOR
// ===========================================================
qs("#passGenBtn").addEventListener("click", () => {
  const len = parseInt(qs("#passLength").value) || 12;
  const chars =
    "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%^&*()";
  let pass = "";
  for (let i = 0; i < len; i++)
    pass += chars[Math.floor(Math.random() * chars.length)];
  qs("#passResult").value = pass;
});

// ===========================================================
// üì¶ IMAGE COMPRESSOR
// ===========================================================
qs("#compressBtn").addEventListener("click", () => {
  const fileInput = qs("#compressFile");
  const quality = parseFloat(qs("#compressQuality").value);
  if (!fileInput.files.length) return alert("Select an image!");

  const file = fileInput.files[0];
  const reader = new FileReader();
  reader.onload = (e) => {
    const img = new Image();
    img.src = e.target.result;
    img.onload = () => {
      const canvas = document.createElement("canvas");
      const ctx = canvas.getContext("2d");
      canvas.width = img.width;
      canvas.height = img.height;
      ctx.drawImage(img, 0, 0);
      canvas.toBlob(
        (blob) => {
          const a = document.createElement("a");
          a.href = URL.createObjectURL(blob);
          a.download = `compressed_${file.name}`;
          a.click();
        },
        "image/jpeg",
        quality
      );
    };
  };
  reader.readAsDataURL(file);
});

// ===========================================================
// ‚úÖ FIXED üí± CURRENCY CONVERTER
// ===========================================================
document.addEventListener("DOMContentLoaded", async () => {
  const fromSel = qs("#curFrom");
  const toSel = qs("#curTo");
  const amountInput = qs("#curAmount");
  const convertBtn = qs("#curConvertBtn");
  const result = qs("#curResult");

  const API_URL = "https://api.exchangerate.host/latest";

  async function loadCurrencies() {
    try {
      const res = await fetch(API_URL);
      const data = await res.json();
      const codes = Object.keys(data.rates);

      fromSel.innerHTML = "";
      toSel.innerHTML = "";

      codes.forEach((code) => {
        const opt1 = document.createElement("option");
        opt1.value = code;
        opt1.textContent = code;
        const opt2 = opt1.cloneNode(true);
        fromSel.appendChild(opt1);
        toSel.appendChild(opt2);
      });

      fromSel.value = "USD";
      toSel.value = "INR";
    } catch (err) {
      console.error("Currency API failed:", err);
      result.textContent = "‚ùå Failed to load currencies.";
    }
  }

  async function convertCurrency() {
    const amount = parseFloat(amountInput.value);
    const from = fromSel.value;
    const to = toSel.value;

    if (isNaN(amount) || amount <= 0) {
      result.textContent = "Enter a valid amount!";
      return;
    }

    try {
      const res = await fetch(`${API_URL}?base=${from}`);
      const data = await res.json();
      const rate = data.rates[to];
      const converted = (amount * rate).toFixed(2);
      result.textContent = `${amount} ${from} = ${converted} ${to}`;
    } catch (err) {
      console.error(err);
      result.textContent = "‚ùå Conversion failed.";
    }
  }

  await loadCurrencies();
  convertBtn.addEventListener("click", convertCurrency);
});

// ===========================================================
// üì¶ QR CODE GENERATOR
// ===========================================================
qs("#qrBtn").addEventListener("click", () => {
  const text = qs("#qrText").value;
  const qrContainer = qs("#qrResult");
  if (!text) return alert("Enter text or URL!");

  qrContainer.innerHTML = "";
  new QRCode(qrContainer, {
    text: text,
    width: 180,
    height: 180,
  });
});

// ===========================================================
// üé¨ YOUTUBE PREVIEW TOOL
// ===========================================================
qs("#ytBtn").addEventListener("click", () => {
  const url = qs("#ytUrl").value.trim();
  const ytPreview = qs("#ytPreview");
  if (!url.includes("youtube.com") && !url.includes("youtu.be"))
    return alert("Enter a valid YouTube URL!");

  const videoId = url.split("v=")[1]?.split("&")[0] || url.split("/").pop();
  ytPreview.innerHTML = `<iframe width="300" height="200"
    src="https://www.youtube.com/embed/${videoId}"
    frameborder="0" allowfullscreen></iframe>`;
});
